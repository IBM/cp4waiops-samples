{"version":3,"file":"ButtonWidget.js","names":["_AlertSummaryAPI","_interopRequireDefault","_FilterViewAPI","obj","__esModule","default","Renderer","constructor","options","content","contentId","getId","containerId","getContainer","canvas","features","buttonElement","document","createElement","id","on","updateButtonProperties","alertSummaryTimer","filterViewAPI","FilterViewAPI","type","alertSummaryAPI","AlertSummaryAPI","groupBy","getAPI","render","domNode","getMaxSeverity","data","severityArr","tenant","alertSummary","summary","map","group","severity","length","Math","max","getAlertCount","reduce","total","count","getSeverityColor","colors","getButtonLabel","labelPropValue","filterName","alertCount","updatedButton","buttonShape","maxSeverity","getPropertyValue","textContent","title","className","textColor","style","getAlertSummaryAndUpdateButton","filterId","fetchedFilter","getData","filter","filters","apiQuery","conditionSetToAPIQuery","conditionSet","decodeURIComponent","name","refreshIntervalPropValue","Number","refreshInterval","getPropertyList","forEach","item","propFilter","getFilter","filterCondition","clearInterval","setInterval","onclick","handleButtonClick","label","ex","console","log","targetPropValue","window","postMessage","source","params","filtername","location","origin","open","renderControl","parentNode","appendChild","parent","Promise","resolve","_default","_exports"],"sources":["../../ext/button/ButtonWidget.js"],"sourcesContent":["/* ******************************************************** {COPYRIGHT-TOP} ****\n * IBM Confidential\n * 5725-Q09, 5737-M96\n * Â© Copyright IBM Corp. 2024\n ********************************************************* {COPYRIGHT-END} ****/\nimport AlertSummaryAPI from '../common/AlertSummaryAPI';\nimport FilterViewAPI from '../common/FilterViewAPI';\nimport {conditionSetToAPIQuery} from '../common/convertConditionSet';\nclass Renderer {\n  constructor(options) {\n    this.content = options.content;\n    this.contentId = this.content.getId();\n    this.containerId = this.content.getContainer().getId();\n    this.canvas = options.features['Dashboard.Canvas'];\n\n    // Create the button element\n    this.buttonElement = document.createElement('button');\n    this.buttonElement.id = `${this.contentId}_button`;\n\n    this.content.on('change:property', () => this.updateButtonProperties());\n    this.alertSummaryTimer = null;\n    this.filterViewAPI = new FilterViewAPI({options: ['filter'], type: 'alert'});\n    this.alertSummaryAPI = new AlertSummaryAPI({groupBy: ['severity']});\n  }\n\n  getAPI() {\n    return {\n      render: (domNode) => this.render(domNode)\n    };\n  }\n\n  getMaxSeverity(data) {\n    const severityArr = data?.data?.tenant?.alertSummary?.summary.map(group => group.severity);\n    if (severityArr.length === 0) {\n      return 0;\n    }\n    return Math.max(...severityArr);\n  }\n\n  getAlertCount(data) {\n    return data?.data?.tenant?.alertSummary?.summary.reduce((total, group) => total + group.count, 0);\n  }\n\n  getSeverityColor(severity) {\n    const colors = {\n      1: '#B23AEE', 2: '#3f71b2', 3: '#408BFC', 4: '#FDD13A', 5: '#FC7B1E', 6: '#DA1E28'\n    };\n    return colors[severity] || '';\n  }\n\n  getButtonLabel(labelPropValue, filterName, alertCount) {\n    if (labelPropValue === 'filterName') {\n      return filterName;\n    }\n    if (labelPropValue === 'alertCount') {\n      return alertCount;\n    }\n    return `${filterName} (${alertCount})`;\n  }\n\n  updatedButton({filterName, buttonShape, alertSummary}) {\n    // get the max severity from the summary data\n    const maxSeverity = this.getMaxSeverity(alertSummary);\n    // set the alert count\n    const alertCount = this.getAlertCount(alertSummary);\n    const labelPropValue = this.content.getPropertyValue('dropdownButtonLabel');\n    // this.buttonElement.textContent = labelOption === 'alertCount' ? `${alertCount}` : buttonLabel;\n    this.buttonElement.textContent = this.getButtonLabel(labelPropValue, filterName, alertCount);\n    this.buttonElement.title = filterName;\n\n    // color the button based on max severity\n    this.buttonElement.className = buttonShape === 'round' ? 'aiops-button round' : 'aiops-button';\n    let textColor = '#FFFFFF';\n    if (maxSeverity < 1 || maxSeverity > 6) {\n      textColor = '';\n    }\n    const style = `background-color: ${this.getSeverityColor(maxSeverity)}; border-color: ${this.getSeverityColor(maxSeverity)}; color: ${textColor}`;\n    this.buttonElement.style = style;\n  }\n\n  async getAlertSummaryAndUpdateButton({filterId, buttonShape}) {\n    // fetch the filter based on filterId\n    const fetchedFilter = await this.filterViewAPI.getData(filterId);\n    const filter = fetchedFilter?.data?.tenant?.filters[0];\n    if (!filter) {\n      this.buttonElement.title = 'Filter not found';\n    }\n    // convert the filter conditionSet to api query\n    const apiQuery = conditionSetToAPIQuery(filter.conditionSet);\n    // fetch alert summary for selected filter\n    const alertSummary = await this.alertSummaryAPI.getData({filter: decodeURIComponent(apiQuery)});\n    this.updatedButton({alertSummary, filterName: filter?.name, buttonShape});\n  }\n\n  async updateButtonProperties() {\n    const buttonShape = this.content.getPropertyValue('dropdownShape');\n    const refreshIntervalPropValue = Number(this.content.getPropertyValue('inputRefreshInterval'));\n    let refreshInterval = 30;\n\n    if (refreshIntervalPropValue && refreshIntervalPropValue >= 10) {\n      refreshInterval = refreshIntervalPropValue;\n    }\n\n    this.content.getPropertyList().forEach(async (item) => {\n      if (typeof item.getPropertyValue() !== 'undefined' && item.id === 'dropdownFilter') {\n        const filterId = item.getPropertyValue();\n        const propFilter = item.getFilter(filterId);\n        const filterCondition = propFilter.conditionSet;\n\n        try {\n          if (!filterCondition) {\n            this.buttonElement.title = 'Filter not found';\n          } else {\n            await this.getAlertSummaryAndUpdateButton({filterId, buttonShape});\n            if (this.alertSummaryTimer) {\n              clearInterval(this.alertSummaryTimer);\n            }\n\n            this.alertSummaryTimer = setInterval(async () => {\n              await this.getAlertSummaryAndUpdateButton({filterId, buttonShape});\n            }, refreshInterval * 1000);\n          }\n          this.buttonElement.onclick = () => this.handleButtonClick(propFilter.label);\n        } catch (ex) {\n          console.log(ex);\n        }\n      }\n    });\n  }\n\n  handleButtonClick(filterName) {\n    const targetPropValue = this.content.getPropertyValue('dropdownTarget');\n    if (targetPropValue === 'update') {\n      window.postMessage({ containerId: this.containerId, source: 'dashboard', params: { filtername: filterName } }, window.location.origin);\n    } else {\n      window.open(`${window.location.origin}/aiops/default/resolution-hub/alerts?filtername=${filterName}`);\n    }\n  }\n\n  renderControl() {\n    this.parentNode.appendChild(this.buttonElement);\n  }\n\n  render(options) {\n    this.parentNode = options.parent;\n    this.renderControl();\n    this.updateButtonProperties();\n\n    return Promise.resolve();\n  }\n}\n\nexport default Renderer;\n"],"mappings":"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","ignoreList":[]}